<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Помодоро таймер</title>
    <meta name="theme-color" content="#0f172a" />
    <style>
      :root {
        --bg: #0b1020;
        --panel: #121a33;
        --muted: #9aa3b2;
        --fg: #e7ecf3;
        --accent: #7c5cff;
        --accent-2: #22c55e;
        --danger: #ef4444;
        --ring: 0 0 0 2px rgba(124, 92, 255, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, Noto Sans, Helvetica, Arial;
        color: var(--fg);
        background: radial-gradient(
            1200px 800px at 75% -10%,
            #192247,
            transparent 60%
          ),
          var(--bg);
        display: grid;
        place-items: center;
        padding: 20px;
      }
      .container {
        width: min(1080px, 100%);
      }
      .grid {
        display: grid;
        gap: 16px;
        grid-template-columns: 1.2fr 0.8fr;
      }
      @media (max-width: 1024px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      .p24 {
        padding: 24px;
      }
      h1 {
        margin: 0 0 6px;
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .muted {
        color: var(--muted);
      }
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .tab,
      .pill {
        appearance: none;
        border: none;
        padding: 10px 14px;
        border-radius: 12px;
        background: #0f1630;
        color: #cdd5e1;
        cursor: pointer;
        font-weight: 600;
      }
      .tab.active {
        background: var(--accent);
        color: white;
        box-shadow: var(--ring);
      }
      .timer {
        display: grid;
        gap: 12px;
        place-items: center;
        padding: 24px 16px;
      }
      .time {
        font-size: clamp(48px, 8vw, 88px);
        font-weight: 900;
        letter-spacing: 2px;
      }
      .big-btns {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .btn {
        appearance: none;
        border: none;
        border-radius: 14px;
        padding: 12px 18px;
        font-weight: 700;
        cursor: pointer;
        color: #0b1020;
      }
      .btn.primary {
        background: var(--accent);
        color: white;
      }
      .btn.success {
        background: var(--accent-2);
        color: black;
      }
      .btn.ghost {
        background: #0f1630;
        color: #dbe3f0;
      }
      .btn.danger {
        background: var(--danger);
        color: white;
      }
      .btn:focus-visible {
        outline: none;
        box-shadow: var(--ring);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .chip {
        background: #0f1630;
        color: #cbd5e1;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(255, 255, 255, 0.07);
      }
      .panel-title {
        margin: 0 0 10px;
        font-size: 14px;
        letter-spacing: 0.2px;
        text-transform: uppercase;
        color: #a9b5c7;
      }
      .settings label {
        display: grid;
        grid-template-columns: 1fr 120px;
        gap: 12px;
        align-items: center;
        margin-bottom: 10px;
      }
      .settings input[type='number'],
      .settings input[type='text'],
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        background: #0f1630;
        color: #e2e8f0;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .switch {
        display: inline-grid;
        grid-auto-flow: column;
        gap: 8px;
        align-items: center;
      }
      .switch input {
        width: 42px;
        height: 24px;
        appearance: none;
        background: #0f1630;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 999px;
        position: relative;
        outline: none;
        cursor: pointer;
      }
      .switch input:checked {
        background: rgba(124, 92, 255, 0.3);
        border-color: var(--accent);
      }
      .switch input::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #fff;
        transition: all 0.2s ease;
      }
      .switch input:checked::after {
        left: 20px;
      }
      .tasks .row {
        justify-content: space-between;
      }
      .task-input {
        display: flex;
        gap: 8px;
      }
      .task-input input {
        flex: 1;
        padding: 12px 14px;
        border-radius: 12px;
        background: #0f1630;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #e2e8f0;
      }
      .task {
        display: grid;
        grid-template-columns: 24px 1fr 24px;
        gap: 10px;
        align-items: center;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        margin-top: 8px;
        background: rgba(255, 255, 255, 0.02);
      }
      .task.done {
        opacity: 0.6;
        text-decoration: line-through;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      @media (max-width: 1024px) {
        .stats {
          grid-template-columns: 1fr 1fr;
        }
      }
      .kpi {
        background: #0f1630;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .kpi .val {
        font-size: 22px;
        font-weight: 900;
      }
      footer {
        margin-top: 18px;
        color: #8aa0bd;
        font-size: 13px;
      }
      a {
        color: #b7c5ff;
      }
      canvas {
        max-height: 260px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="container">
      <div class="card p24">
        <h1>Помодоро таймер</h1>
        <div class="muted">
          Простая система для фокуса: 25/5, длинный перерыв каждые 4 сета.
          Горячие клавиши: <b>Space</b> — старт/пауза, <b>R</b> — сброс,
          <b>1</b>/<b>2</b>/<b>3</b> — режимы.
        </div>

        <div class="grid" id="app">
          <!-- LEFT: Timer + Tasks -->
          <section class="card p24">
            <div class="tabs" id="modeTabs"></div>
            <div class="timer">
              <div class="time" id="time">25:00</div>
              <div class="big-btns">
                <button class="btn primary" id="startPause">Старт</button>
                <button class="btn ghost" id="skip">Пропустить</button>
                <button class="btn danger" id="reset">Сброс</button>
              </div>
              <div class="row">
                <span class="chip" id="roundInfo">Раунд 1/4</span>
                <span class="chip" id="currentTask">Задача: —</span>
                <span class="chip" id="status">Готов</span>
              </div>
              <div class="row" style="gap: 12px">
                <label class="switch" title="Активный проект">
                  <span style="min-width: 70px; color: #a9b5c7">Проект</span>
                  <select id="activeProject"></select>
                </label>
                <button class="pill" id="quickAddProject">+ Проект</button>
              </div>
            </div>

            <div class="tasks">
              <div class="row">
                <h3 style="margin: 0">Задачи</h3>
                <div class="task-input">
                  <input id="taskText" placeholder="Добавить задачу и Enter…" />
                  <button class="btn success" id="addTask">Добавить</button>
                </div>
              </div>
              <div id="taskList"></div>
            </div>
          </section>

          <!-- RIGHT: Settings + Stats -->
          <section class="card p24">
            <h3 class="panel-title">Настройки</h3>
            <div class="settings">
              <label
                >Фокус (мин)
                <input id="focusMins" type="number" min="1" value="25"
              /></label>
              <label
                >Короткий перерыв (мин)
                <input id="shortMins" type="number" min="1" value="5"
              /></label>
              <label
                >Длинный перерыв (мин)
                <input id="longMins" type="number" min="1" value="15"
              /></label>
              <label
                >Раундов до длинного
                <input id="roundsToLong" type="number" min="2" value="4"
              /></label>
              <div class="switch">
                <input id="autoNext" type="checkbox" />
                <span>Автостарт следующего этапа</span>
              </div>
              <div class="switch">
                <input id="soundOn" type="checkbox" checked />
                <span>Звук по окончании</span>
              </div>
              <div class="switch">
                <input id="notifyOn" type="checkbox" />
                <span>Уведомления браузера</span>
              </div>
              <div class="row" style="margin-top: 10px">
                <button class="btn ghost" id="saveSettings">Сохранить</button>
                <button class="btn" id="resetStats">Сбросить статистику</button>
              </div>

              <h3 class="panel-title" style="margin-top: 20px">Проекты</h3>
              <div class="row" style="gap: 8px">
                <input
                  id="newProjectName"
                  type="text"
                  placeholder="Название проекта"
                />
                <button class="btn success" id="addProjectBtn">
                  Добавить проект
                </button>
              </div>
              <div
                id="projectList"
                style="margin-top: 8px; display: grid; gap: 6px"
              ></div>
            </div>

            <h3 class="panel-title">Аккаунт</h3>
            <div
              class="row"
              style="gap: 8px; align-items: center; margin-bottom: 14px"
            >
              <input
                id="authEmail"
                type="email"
                placeholder="you@example.com"
                style="
                  flex: 1;
                  padding: 10px 12px;
                  border-radius: 10px;
                  background: #0f1630;
                  color: #e2e8f0;
                  border: 1px solid rgba(255, 255, 255, 0.08);
                "
              />
              <button class="btn" id="btnLogin" type="button">
                Войти по email
              </button>
              <button
                class="btn ghost"
                id="btnLogout"
                type="button"
                style="display: none"
              >
                Выйти
              </button>
            </div>
            <div class="muted" id="authStatus">
              Не вошли. Данные сохраняются только локально.
            </div>
            <hr
              style="
                border: none;
                border-top: 1px solid rgba(255, 255, 255, 0.08);
                margin: 14px 0;
              "
            />

            <h3 class="panel-title" style="margin-top: 18px">Статистика</h3>
            <div class="stats">
              <div class="kpi">
                <div class="muted">Фокус сегодня</div>
                <div class="val" id="kpiToday">0 мин</div>
              </div>
              <div class="kpi">
                <div class="muted">Завершено сетов</div>
                <div class="val" id="kpiSets">0</div>
              </div>
              <div class="kpi">
                <div class="muted">Всего фокуса</div>
                <div class="val" id="kpiTotal">0 мин</div>
              </div>
            </div>

            <div class="row" style="margin-top: 10px; gap: 8px">
              <span class="panel-title" style="margin: 0">График</span>
              <div class="tabs" id="chartTabs">
                <button class="tab active" data-range="day">День</button>
                <button class="tab" data-range="week">Неделя</button>
                <button class="tab" data-range="month">Месяц</button>
              </div>
              <select id="chartProject" title="Фильтр проекта"></select>
            </div>
            <div class="card" style="margin-top: 8px; padding: 12px">
              <canvas id="focusChart" height="120"></canvas>
            </div>

            <footer>
              Сделано для StackBlitz • Локальное сохранение (localStorage).
              Исходники — один файл. Автор: вы ❤
            </footer>
          </section>
        </div>
      </div>
    </div>

    <script>
      (() => {
        // ===== Cloud (Supabase) config
        const SUPABASE_URL = 'https://xilejbksbuexrncvtunb.supabase.co'; // <= замени
        const SUPABASE_ANON_KEY =
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpbGVqYmtzYnVleHJuY3Z0dW5iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0NjMxNDcsImV4cCI6MjA3NzAzOTE0N30.sF9ffDQYpxXSqbqlCNkklSoC0ZTzqO3pskOZ9AyHKsY'; // <= замени
        const supa =
          SUPABASE_URL.startsWith('https://') &&
          !SUPABASE_ANON_KEY.includes('YOUR_')
            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
            : null;

        // ===== Helpers
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const fmt = (s) => String(Math.floor(s)).padStart(2, '0');

        // ===== State & Persistence
        const LS_KEY = 'pomodoro.v2';
        const nowISO = () => new Date().toISOString().slice(0, 10);

        const defaultState = {
          settings: {
            focus: 25,
            short: 5,
            long: 15,
            roundsToLong: 4,
            autoNext: false,
            soundOn: true,
            notifyOn: false,
          },
          mode: 'focus',
          rounds: 1,
          remaining: 25 * 60,
          running: false,
          tasks: [],
          projects: [{ id: 'default', name: 'Общее' }],
          activeProjectId: 'default',
          stats: {
            todayDate: nowISO(),
            todayFocusMin: 0,
            setsDone: 0,
            totalFocusMin: 0,
            history: {},
            todayByHour: Array.from({ length: 24 }, () => 0),
            project: {
              default: {
                total: 0,
                history: {},
                todayByHour: Array.from({ length: 24 }, () => 0),
              },
            },
          },
        };

        let state = load() || defaultState;
        migrateState();

        function load() {
          try {
            return JSON.parse(localStorage.getItem(LS_KEY));
          } catch (e) {
            return null;
          }
        }
        function save() {
          localStorage.setItem(LS_KEY, JSON.stringify(state));
        }

        function migrateState() {
          const d = nowISO();
          if (!state.stats)
            state.stats = {
              todayDate: d,
              todayFocusMin: 0,
              setsDone: 0,
              totalFocusMin: 0,
              history: {},
              todayByHour: Array.from({ length: 24 }, () => 0),
              project: {},
            };
          if (!state.stats.history) state.stats.history = {};
          if (!state.stats.todayByHour)
            state.stats.todayByHour = Array.from({ length: 24 }, () => 0);
          if (
            !state.projects ||
            !Array.isArray(state.projects) ||
            state.projects.length === 0
          ) {
            state.projects = [{ id: 'default', name: 'Общее' }];
          }
          if (!state.activeProjectId)
            state.activeProjectId = state.projects[0].id;
          if (!state.stats.project) state.stats.project = {};
          state.projects.forEach((p) => {
            if (!state.stats.project[p.id])
              state.stats.project[p.id] = {
                total: 0,
                history: {},
                todayByHour: Array.from({ length: 24 }, () => 0),
              };
          });
          if (state.stats.todayDate !== d) {
            state.stats.todayDate = d;
            state.stats.todayFocusMin = 0;
            state.stats.todayByHour = Array.from({ length: 24 }, () => 0);
            Object.values(state.stats.project).forEach(
              (ps) => (ps.todayByHour = Array.from({ length: 24 }, () => 0))
            );
          }
        }

        // ===== UI Elements
        const timeEl = $('#time'),
          startBtn = $('#startPause'),
          skipBtn = $('#skip'),
          resetBtn = $('#reset');
        const roundInfo = $('#roundInfo'),
          statusEl = $('#status'),
          currentTask = $('#currentTask');
        const modeTabs = $('#modeTabs');

        const focusMins = $('#focusMins'),
          shortMins = $('#shortMins'),
          longMins = $('#longMins'),
          roundsToLong = $('#roundsToLong');
        const autoNext = $('#autoNext'),
          soundOn = $('#soundOn'),
          notifyOn = $('#notifyOn');

        const saveSettingsBtn = $('#saveSettings'),
          resetStatsBtn = $('#resetStats');
        const kpiToday = $('#kpiToday'),
          kpiSets = $('#kpiSets'),
          kpiTotal = $('#kpiTotal');

        const taskText = $('#taskText'),
          addTask = $('#addTask'),
          taskList = $('#taskList');

        const activeProjectSel = $('#activeProject');
        const quickAddProject = $('#quickAddProject');
        const newProjectName = $('#newProjectName');
        const addProjectBtn = $('#addProjectBtn');
        const projectList = $('#projectList');

        const chartTabs = document.getElementById('chartTabs');
        const chartCanvas = document.getElementById('focusChart');
        const chartProjectSel = document.getElementById('chartProject');
        // Auth UI
        const authEmail = document.getElementById('authEmail');
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const authStatus = document.getElementById('authStatus');

        // ===== Modes
        const MODES = [
          {
            id: 'focus',
            label: 'Фокус',
            get secs() {
              return state.settings.focus * 60;
            },
          },
          {
            id: 'short',
            label: 'Перерыв',
            get secs() {
              return state.settings.short * 60;
            },
          },
          {
            id: 'long',
            label: 'Длинный',
            get secs() {
              return state.settings.long * 60;
            },
          },
        ];

        function renderTabs() {
          modeTabs.innerHTML = '';
          MODES.forEach((m) => {
            const b = document.createElement('button');
            b.className = 'tab' + (state.mode === m.id ? ' active' : '');
            b.textContent = m.label;
            b.onclick = () => {
              switchMode(m.id, true);
              renderTabs();
            };
            modeTabs.appendChild(b);
          });
        }

        function switchMode(id, manual = false) {
          state.mode = id;
          state.remaining = MODES.find((m) => m.id === id).secs;
          state.running = false;
          startBtn.textContent = 'Старт';
          statusEl.textContent = manual ? 'Режим переключён' : 'Готов';
          renderTime();
          save();
        }

        // ===== Timer Engine
        let raf, lastTick;
        function tick(ts) {
          if (!state.running) {
            lastTick = ts;
            raf = requestAnimationFrame(tick);
            return;
          }
          if (!lastTick) lastTick = ts;
          const dt = (ts - lastTick) / 1000;
          lastTick = ts;
          state.remaining -= dt;
          if (state.remaining <= 0) {
            state.remaining = 0;
            state.running = false;
            onTimerEnd();
          }
          renderTime();
          raf = requestAnimationFrame(tick);
        }

        function start() {
          state.running = true;
          startBtn.textContent = 'Пауза';
          statusEl.textContent = 'Идёт…';
          save();
        }
        function pause() {
          state.running = false;
          startBtn.textContent = 'Старт';
          statusEl.textContent = 'Пауза';
          save();
        }

        function onTimerEnd() {
          statusEl.textContent = 'Готов';
          notify('Время вышло', labelFor(state.mode));
          if (state.settings.soundOn) beep();
          if (state.mode === 'focus') {
            const addMin = Math.round(MODES[0].secs / 60);
            state.stats.todayFocusMin += addMin;
            state.stats.totalFocusMin += addMin;
            state.stats.setsDone += 1;
            const d = nowISO();
            state.stats.history[d] = (state.stats.history[d] || 0) + addMin;
            const h = new Date().getHours();
            state.stats.todayByHour[h] =
              (state.stats.todayByHour[h] || 0) + addMin;
            const pid = state.activeProjectId;
            const ps =
              state.stats.project[pid] ||
              (state.stats.project[pid] = {
                total: 0,
                history: {},
                todayByHour: Array.from({ length: 24 }, () => 0),
              });
            ps.total += addMin;
            ps.history[d] = (ps.history[d] || 0) + addMin;
            ps.todayByHour[h] = (ps.todayByHour[h] || 0) + addMin;
            state.rounds = (state.rounds % state.settings.roundsToLong) + 1;
            renderChart();
          }
          if (state.settings.autoNext) {
            if (state.mode === 'focus')
              state.mode =
                (state.rounds - 1) % state.settings.roundsToLong === 0
                  ? 'long'
                  : 'short';
            else state.mode = 'focus';
            state.remaining = MODES.find((m) => m.id === state.mode).secs;
            state.running = true;
            startBtn.textContent = 'Пауза';
          }
          save();
          renderKPIs();
          renderRound();
          // push to cloud (best-effort)
          pushStatsToCloud({ day: d, minutes: addMin, projectId: pid }).catch(
            () => {}
          );
        }

        // ===== Notifications & Sound (simple beep)
        function beep() {
          try {
            const ac = new (window.AudioContext || window.webkitAudioContext)();
            const o = ac.createOscillator();
            const g = ac.createGain();
            o.type = 'sine';
            o.frequency.setValueAtTime(660, ac.currentTime);
            g.gain.setValueAtTime(0.001, ac.currentTime);
            o.connect(g).connect(ac.destination);
            g.gain.exponentialRampToValueAtTime(0.2, ac.currentTime + 0.02);
            g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + 0.6);
            o.start();
            o.stop(ac.currentTime + 0.6);
          } catch (e) {}
        }
        function notify(title, body) {
          if (!state.settings.notifyOn) return;
          if (Notification.permission === 'granted')
            new Notification(title, { body });
          else if (Notification.permission !== 'denied')
            Notification.requestPermission().then((p) => {
              if (p === 'granted') new Notification(title, { body });
            });
        }
        function labelFor(mode) {
          return mode === 'focus'
            ? 'Фокус'
            : mode === 'short'
            ? 'Короткий перерыв'
            : 'Длинный перерыв';
        }

        // ===== Render helpers
        function renderTime() {
          const s = Math.ceil(state.remaining);
          timeEl.textContent = `${fmt(s / 60)}:${fmt(s % 60)}`;
        }
        function renderKPIs() {
          kpiToday.textContent = `${state.stats.todayFocusMin} мин`;
          kpiSets.textContent = state.stats.setsDone;
          kpiTotal.textContent = `${state.stats.totalFocusMin} мин`;
        }
        function renderRound() {
          roundInfo.textContent = `Раунд ${state.rounds}/${state.settings.roundsToLong}`;
        }
        function renderTasks() {
          taskList.innerHTML = '';
          state.tasks.forEach((t) => {
            const e = document.createElement('div');
            e.className = 'task' + (t.done ? ' done' : '');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.checked = t.done;
            cb.onchange = () => {
              t.done = cb.checked;
              save();
              renderTasks();
            };
            const span = document.createElement('div');
            span.textContent = t.text;
            const del = document.createElement('button');
            del.className = 'btn ghost';
            del.textContent = '×';
            del.onclick = () => {
              state.tasks = state.tasks.filter((x) => x.id !== t.id);
              save();
              renderTasks();
              updateCurrentTask();
            };
            e.append(cb, span, del);
            taskList.appendChild(e);
          });
          updateCurrentTask();
        }
        function updateCurrentTask() {
          const t = state.tasks.find((t) => !t.done);
          currentTask.textContent = 'Задача: ' + (t ? t.text : '—');
        }

        function renderProjectsUI() {
          activeProjectSel.innerHTML = '';
          state.projects.forEach((p) => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            if (p.id === state.activeProjectId) opt.selected = true;
            activeProjectSel.appendChild(opt);
          });
          chartProjectSel.innerHTML = '';
          const optAll = document.createElement('option');
          optAll.value = '__all__';
          optAll.textContent = 'Все проекты';
          chartProjectSel.appendChild(optAll);
          state.projects.forEach((p) => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            chartProjectSel.appendChild(opt);
          });
          if (
            !['__all__', ...state.projects.map((p) => p.id)].includes(
              chartProjectSel.value
            )
          )
            chartProjectSel.value = '__all__';
          projectList.innerHTML = '';
          state.projects.forEach((p) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.style.justifyContent = 'space-between';
            const info = document.createElement('div');
            info.textContent = p.name;
            const right = document.createElement('div');
            right.className = 'row';
            const setBtn = document.createElement('button');
            setBtn.className = 'pill';
            setBtn.textContent = 'Сделать активным';
            setBtn.type = 'button';
            setBtn.dataset.action = 'set-active';
            setBtn.dataset.id = p.id;
            const delBtn = document.createElement('button');
            delBtn.className = 'pill';
            delBtn.textContent = 'Удалить';
            delBtn.type = 'button';
            delBtn.dataset.action = 'delete';
            delBtn.dataset.id = p.id;
            if (p.id === 'default') delBtn.disabled = true;
            right.append(setBtn, delBtn);
            row.append(info, right);
            projectList.appendChild(row);
          });
        }

        function render() {
          focusMins.value = state.settings.focus;
          shortMins.value = state.settings.short;
          longMins.value = state.settings.long;
          roundsToLong.value = state.settings.roundsToLong;
          autoNext.checked = state.settings.autoNext;
          soundOn.checked = state.settings.soundOn;
          notifyOn.checked = state.settings.notifyOn;
          renderTabs();
          renderTime();
          renderRound();
          renderKPIs();
          renderTasks();
          renderProjectsUI();
        }

        // ===== Events
        startBtn.onclick = () => (state.running ? pause() : start());
        skipBtn.onclick = () => {
          state.remaining = 0.01;
          save();
        };
        resetBtn.onclick = () => {
          state.remaining = MODES.find((m) => m.id === state.mode).secs;
          pause();
          renderTime();
          save();
        };

        activeProjectSel.onchange = () => {
          state.activeProjectId = activeProjectSel.value;
          save();
        };
        quickAddProject.onclick = () => {
          const name = prompt('Название проекта:')?.trim();
          if (!name) return;
          addProject(name);
        };
        addProjectBtn.onclick = () => {
          const name = newProjectName.value.trim();
          if (!name) return addProjectBtn.blur();
          addProject(name);
          newProjectName.value = '';
        };

        function addProject(name) {
          const id = crypto.randomUUID();
          state.projects.push({ id, name });
          state.stats.project[id] = {
            total: 0,
            history: {},
            todayByHour: Array.from({ length: 24 }, () => 0),
          };
          state.activeProjectId = id;
          save();
          pushProjectToCloud({ id, name }).catch(() => {});
          renderProjectsUI();
          renderChart();
        }
        function deleteProject(id) {
          if (id === 'default') return;
          if (!confirm('Удалить проект и его статистику?')) return;
          state.projects = state.projects.filter((p) => p.id !== id);
          delete state.stats.project[id];
          if (state.activeProjectId === id) state.activeProjectId = 'default';
          if (chartProjectSel && chartProjectSel.value === id)
            chartProjectSel.value = '__all__';
          save();
          renderProjectsUI();
          renderChart();
          deleteProjectFromCloud(id).catch(() => {});
        }

        saveSettingsBtn.onclick = () => {
          const f = Math.max(1, +focusMins.value | 0),
            s = Math.max(1, +shortMins.value | 0),
            l = Math.max(1, +longMins.value | 0),
            r = Math.max(2, +roundsToLong.value | 0);
          state.settings = {
            focus: f,
            short: s,
            long: l,
            roundsToLong: r,
            autoNext: autoNext.checked,
            soundOn: soundOn.checked,
            notifyOn: notifyOn.checked,
          };
          if (state.mode === 'focus') state.remaining = f * 60;
          if (state.mode === 'short') state.remaining = s * 60;
          if (state.mode === 'long') state.remaining = l * 60;
          statusEl.textContent = 'Сохранено';
          save();
          renderTime();
        };

        resetStatsBtn.onclick = () => {
          if (confirm('Сбросить статистику?')) {
            const d = nowISO();
            state.stats = {
              todayDate: d,
              todayFocusMin: 0,
              setsDone: 0,
              totalFocusMin: 0,
              history: {},
              todayByHour: Array.from({ length: 24 }, () => 0),
              project: {},
            };
            state.projects.forEach(
              (p) =>
                (state.stats.project[p.id] = {
                  total: 0,
                  history: {},
                  todayByHour: Array.from({ length: 24 }, () => 0),
                })
            );
            save();
            renderKPIs();
            renderChart();
          }
        };

        addTask.onclick = addTaskFromInput;
        taskText.onkeydown = (e) => {
          if (e.key === 'Enter') {
            addTaskFromInput();
          }
        };
        function addTaskFromInput() {
          const t = taskText.value.trim();
          if (!t) return;
          state.tasks.push({ id: crypto.randomUUID(), text: t, done: false });
          taskText.value = '';
          save();
          renderTasks();
        }

        window.addEventListener('keydown', (e) => {
          if (
            ['INPUT', 'TEXTAREA', 'SELECT'].includes(
              document.activeElement.tagName
            )
          )
            return;
          if (e.code === 'Space') {
            e.preventDefault();
            state.running ? pause() : start();
          }
          if (e.key === 'r' || e.key === 'R') {
            e.preventDefault();
            resetBtn.click();
          }
          if (e.key === '1') {
            switchMode('focus', true);
            renderTabs();
          }
          if (e.key === '2') {
            switchMode('short', true);
            renderTabs();
          }
          if (e.key === '3') {
            switchMode('long', true);
            renderTabs();
          }
        });
        // ===== Auth & Cloud helpers
        function setAuthUI(user) {
          if (!authStatus) return;
          if (user) {
            authStatus.textContent = `Вошли как ${user.email}. Данные синхронизируются.`;
            btnLogin.style.display = 'none';
            btnLogout.style.display = 'inline-block';
            authEmail.style.display = 'none';
          } else {
            authStatus.textContent =
              'Не вошли. Данные сохраняются только локально.';
            btnLogin.style.display = 'inline-block';
            btnLogout.style.display = 'none';
            authEmail.style.display = '';
          }
        }

        async function login() {
          if (!supa) {
            alert(
              'Supabase не настроен. Задай SUPABASE_URL и SUPABASE_ANON_KEY.'
            );
            return;
          }
          const email = authEmail.value.trim();
          if (!email) return alert('Введи email');
          const { error } = await supa.auth.signInWithOtp({
            email,
            options: { emailRedirectTo: location.href },
          });
          if (error) alert(error.message);
          else alert('Проверь почту — отправили магическую ссылку!');
        }
        async function logout() {
          if (!supa) return;
          await supa.auth.signOut();
          location.reload();
        }

        async function onSignedIn(user) {
          setAuthUI(user);
          try {
            const [projects, stats] = await Promise.all([
              pullProjectsFromCloud(),
              pullStatsFromCloud(120),
            ]);
            // merge projects
            if (projects?.length) {
              const existing = new Set(state.projects.map((p) => p.id));
              projects.forEach((p) => {
                if (!existing.has(p.id)) {
                  state.projects.push({ id: p.id, name: p.name });
                  state.stats.project[p.id] = state.stats.project[p.id] || {
                    total: 0,
                    history: {},
                    todayByHour: Array.from({ length: 24 }, () => 0),
                  };
                }
              });
            }
            // merge stats
            if (stats?.length) {
              stats.forEach((row) => {
                const day = row.day.slice(0, 10);
                const minutes = row.minutes | 0;
                if (row.project_id) {
                  const ps =
                    state.stats.project[row.project_id] ||
                    (state.stats.project[row.project_id] = {
                      total: 0,
                      history: {},
                      todayByHour: Array.from({ length: 24 }, () => 0),
                    });
                  ps.history[day] = Math.max(ps.history[day] || 0, minutes);
                  ps.total = Object.values(ps.history).reduce(
                    (a, b) => a + b,
                    0
                  );
                } else {
                  state.stats.history[day] = Math.max(
                    state.stats.history[day] || 0,
                    minutes
                  );
                }
              });
            }
            save();
            renderProjectsUI();
            renderChart();
            renderKPIs();
          } catch (err) {
            console.warn('sync failed', err);
          }
        }
        function onSignedOut() {
          setAuthUI(null);
        }

        if (supa) {
          supa.auth.getUser().then(({ data }) => {
            const user = data?.user;
            user ? onSignedIn(user) : onSignedOut();
          });
          supa.auth.onAuthStateChange((_evt, session) => {
            const user = session?.user;
            user ? onSignedIn(user) : onSignedOut();
          });
        } else {
          setAuthUI(null);
        }

        btnLogin?.addEventListener('click', login);
        btnLogout?.addEventListener('click', logout);

        async function pushProjectToCloud({ id, name }) {
          if (!supa) return;
          const u = (await supa.auth.getUser()).data.user;
          if (!u) return;
          await supa.from('projects').upsert({ id, user_id: u.id, name });
        }
        async function deleteProjectFromCloud(id) {
          if (!supa) return;
          const u = (await supa.auth.getUser()).data.user;
          if (!u) return;
          await supa.from('projects').delete().eq('id', id).eq('user_id', u.id);
        }

        async function pushStatsToCloud({ day, minutes, projectId }) {
          if (!supa) return;
          const u = (await supa.auth.getUser()).data.user;
          if (!u) return;
          const { data: rows, error: selErr } = await supa
            .from('stats_by_day')
            .select('minutes')
            .eq('user_id', u.id)
            .eq('day', day)
            .eq('project_id', projectId || null)
            .limit(1);
          if (selErr) {
            console.warn(selErr);
            return;
          }
          const current = rows?.[0]?.minutes || 0;
          const total = current + minutes;
          const { error: upErr } = await supa
            .from('stats_by_day')
            .upsert({
              user_id: u.id,
              project_id: projectId || null,
              day,
              minutes: total,
            });
          if (upErr) console.warn(upErr);
        }

        async function pullProjectsFromCloud() {
          if (!supa) return [];
          const u = (await supa.auth.getUser()).data.user;
          if (!u) return [];
          const { data } = await supa
            .from('projects')
            .select('id,name')
            .order('created_at', { ascending: true });
          return data || [];
        }
        async function pullStatsFromCloud(days) {
          if (!supa) return [];
          const u = (await supa.auth.getUser()).data.user;
          if (!u) return [];
          const since = new Date();
          since.setDate(since.getDate() - (days || 60));
          const { data } = await supa
            .from('stats_by_day')
            .select('day,minutes,project_id')
            .gte('day', since.toISOString().slice(0, 10));
          return data || [];
        }

        // ===== Chart helpers & data series
        let chart,
          chartRange = 'day';
        function getLastNDates(n) {
          const res = [];
          const base = new Date();
          for (let i = n - 1; i >= 0; i--) {
            const d = new Date(base);
            d.setDate(base.getDate() - i);
            res.push(d.toISOString().slice(0, 10));
          }
          return res;
        }
        function getSeries(range, projectId) {
          let labels = [],
            data = [];
          if (range === 'day') {
            labels = Array.from({ length: 24 }, (_, h) => `${h}:00`);
            data =
              projectId && projectId !== '__all__'
                ? state.stats.project[projectId]?.todayByHour ||
                  Array.from({ length: 24 }, () => 0)
                : state.stats.todayByHour;
          } else {
            const n = range === 'week' ? 7 : 30;
            const days = getLastNDates(n);
            labels = days.map((d) => d.slice(5));
            data = days.map((d) =>
              projectId && projectId !== '__all__'
                ? state.stats.project[projectId]?.history?.[d] || 0
                : state.stats.history[d] || 0
            );
          }
          return { labels, data };
        }
        function renderChart(range = chartRange) {
          chartRange = range;
          const pid = chartProjectSel?.value || '__all__';
          const { labels, data } = getSeries(range, pid);
          const ds = {
            label:
              pid === '__all__'
                ? 'Минуты фокуса (все проекты)'
                : 'Минуты фокуса',
            data,
            borderWidth: 1,
            backgroundColor: 'rgba(124,92,255,0.6)',
            borderColor: 'rgba(124,92,255,1)',
            borderRadius: 4,
          };
          if (chart) {
            chart.config.type = 'bar';
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.data.datasets[0].label = ds.label;
            chart.update();
            return;
          }
          chart = new Chart(chartCanvas, {
            type: 'bar',
            data: { labels, datasets: [ds] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  grid: { color: 'rgba(255,255,255,.05)' },
                  ticks: { color: '#a9b5c7' },
                },
                y: {
                  beginAtZero: true,
                  grid: { color: 'rgba(255,255,255,.07)' },
                  ticks: { color: '#a9b5c7' },
                },
              },
              plugins: {
                legend: { labels: { color: '#dbe3f0' } },
                tooltip: { enabled: true },
              },
            },
          });
        }

        if (chartTabs) {
          chartTabs.addEventListener('click', (e) => {
            const b = e.target.closest('button.tab');
            if (!b) return;
            chartTabs
              .querySelectorAll('.tab')
              .forEach((x) => x.classList.remove('active'));
            b.classList.add('active');
            renderChart(b.dataset.range);
          });
        }
        if (chartProjectSel) {
          chartProjectSel.onchange = () => renderChart();
        }

        if (projectList) {
          projectList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.dataset.action,
              id = btn.dataset.id;
            if (action === 'delete') {
              deleteProject(id);
              return;
            }
            if (action === 'set-active') {
              state.activeProjectId = id;
              save();
              renderProjectsUI();
            }
          });
        }

        // ===== Self-tests (quick regression)
        (() => {
          try {
            console.group('%cPomodoro self-tests', 'color:#7c5cff');
            console.assert(
              typeof state.settings.focus === 'number' &&
                state.settings.focus > 0,
              'focus setting'
            );
            console.assert(
              Array.isArray(state.projects) && state.projects.length >= 1,
              'projects exist'
            );
            console.assert(
              state.stats.project[state.activeProjectId],
              'active project stats exists'
            );
            const d1 = getSeries('day', '__all__');
            console.assert(d1.data.length === 24, 'day len');
            const d2 = getSeries('week', '__all__');
            console.assert(d2.data.length === 7, 'week len');
            const d3 = getSeries('month', '__all__');
            console.assert(d3.data.length === 30, 'month len');
            console.groupEnd();
          } catch (err) {
            console.warn('Self-tests failed', err);
          }
        })();

        // ===== Init
        render();
        renderChart('day');
        requestAnimationFrame(tick);
      })();
    </script>
  </body>
</html>
